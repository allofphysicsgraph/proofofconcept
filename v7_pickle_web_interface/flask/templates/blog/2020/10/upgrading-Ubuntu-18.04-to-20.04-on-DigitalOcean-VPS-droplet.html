{% extends "_base.html" %}
{% block content %}

<H1>upgrading Ubuntu 18.04 to 20.04 on DigitalOcean VPS droplet</H1>

<P><small>Published 2020-10-11T22:19:00.005Z by Physics Derivation Graph</small></P>

<p>I've been running a DigitalOcean droplet for $5/month for the past 6 months. Because I was new and didn't know better, I selected the Ubuntu 18.04 droplet.&nbsp;</p><p>Now I want to update to Ubuntu 20.04 LTS.&nbsp;</p><p><a href="https://www.digitalocean.com/community/tutorials/how-to-upgrade-to-ubuntu-20-04-focal-fossa">The guide</a> recommends starting with a fresh 20.04 image instead of upgrading.&nbsp;</p><p>The following is a record of the steps I took in this process.&nbsp;</p><p>Total duration: 2 hours. The process took longer than expected because I hadn't previously configured the website from a bare Ubuntu server. Also, I had made a few changes since the initial installation that weren't documented.</p><h3 style="text-align: left;">Step 1: collect all data prior to turning off the server</h3><p>Used scp to copy data from the droplet to my mac</p><p>
  <span style="font-family: courier;">
scp user@IP:/home/pdg/arxiv_rss/rss_filter_email.py .<br />
scp user@IP:/home/pdg/arxiv_rss/.env .<br />
scp user@IP:/home/pdg/videos/* .<br />
scp user@IP:/home/pdg/.bash_history .<br />
scp user@IP:/home/pdg/.bashrc .<br />
scp user@IP:/home/pdg/.python_history .<br />
scp user@IP:/home/pdg/.sqlite_history .<br />
cd proofofconcept/v7_pickle_web_interface/<br />
scp user@IP:/home/pdg/proofofconcept/v7_pickle_web_interface/.env .<br />
scp user@IP:/home/pdg/proofofconcept/v7_pickle_web_interface/certs/* .<br />
scp user@IP:/home/pdg/proofofconcept/v7_pickle_web_interface/flask/logs/* .<br />
scp user@IP:/home/pdg/.ssh/authorized_keys .<br />
    </span>
</p><p>Grab the crontab entry</p><p><span style="font-family: courier;">0 0 * * * /usr/bin/python3 /home/user/arxiv_rss/rss_filter_email.py &gt;&gt; /home/user/arxiv_rss/cron.log 2&gt;&amp;1</span></p><h3 style="text-align: left;">Step 2: power off the server and take a snapshot</h3><p><a href="https://www.digitalocean.com/docs/images/snapshots/how-to/snapshot-droplets/">https://www.digitalocean.com/docs/images/snapshots/how-to/snapshot-droplets/</a></p><h3 style="text-align: left;">Step 3: Start a new droplet</h3><div>Selected Ubuntu 20.04</div><div><br /></div><h3 style="text-align: left;">Step 4: configure accounts and access</h3><div>see&nbsp;<a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-20-04">https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-20-04</a></div><div><span style="font-family: courier;">adduser pdg</span></div><div><span style="font-family: courier;">usermod -aG sudo pdg</span></div><div><span style="font-family: courier;"><br /></span></div><div><span style="font-family: courier;">ufw allow OpenSSH</span></div><div><span style="font-family: courier;">ufw enable</span></div><div><br /></div><div>Instead of creating new SSH key pairs,&nbsp;</div><div><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys-on-ubuntu-20-04">https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys-on-ubuntu-20-04</a></div><div>I imported my authorized_keys file to /home/pdg/.ssh/</div><div><br />To get the authorized_keys file I temporarily allowed password-based authentication for scp using</div><div><span style="font-family: courier;">sudo vim /etc/ssh/sshd_config</span></div><div>change "PasswordAuthentication No" to "PasswordAuthentication Yes"</div><div><span style="font-family: courier;">sudo service ssh restart</span></div><div>While I was there, I also ran</div><div>change "PermitRootLogin yes" to "permitRootLogin no"</div><div><div>Once I had transferred the authorized_keys file, I reverted to "PasswordAuthentication No" and ran</div><div><span style="font-family: courier;">sudo service ssh restart</span></div></div><div><br /></div><div>See also&nbsp;<a href="https://www.thegeekstuff.com/2011/05/openssh-options/">https://www.thegeekstuff.com/2011/05/openssh-options/</a></div><div><br /></div><div><span style="font-family: courier;">sudo ufw allow 443</span></div><div><span style="font-family: courier;">sudo ufw allow 80</span></div><h3 style="text-align: left;">Step 5: update OS</h3><div><br /></div><div><span style="font-family: courier;">sudo apt-get update</span></div><div><span style="font-family: courier;">sudo apt-get upgrade</span></div><div><br /></div><h3 style="text-align: left;">Step 6: install metrics</h3><div><br /></div><div><a href="https://www.digitalocean.com/docs/monitoring/how-to/upgrade-legacy-agent/">https://www.digitalocean.com/docs/monitoring/how-to/upgrade-legacy-agent/</a></div><div><span style="font-family: courier;">sudo apt-get purge do-agent</span></div><div><span style="font-family: courier;">curl -sSL https://repos.insights.digitalocean.com/install.sh -o /tmp/install.sh</span></div><div><span style="font-family: courier;">sudo bash /tmp/install.sh</span></div><div><span style="font-family: courier;">/opt/digitalocean/bin/do-agent --version</span></div><h3 style="text-align: left;">Step 7: install Docker and Docker-Compose</h3><div><a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-20-04">https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-20-04</a></div><div><br /></div><div><a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-compose-on-ubuntu-20-04">https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-compose-on-ubuntu-20-04</a></div><h3 style="text-align: left;">Step 8: certs</h3><div style="text-align: left;"><a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-20-04">https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-20-04</a></div><div style="text-align: left;">sudo apt install certbot python3-certbot-nginx</div><div style="text-align: left;"><div>sudo certbot certonly --webroot \</div><div>&nbsp; &nbsp; &nbsp;-w /home/pdg/proofofconcept/v7_pickle_web_interface/certs \</div><div>&nbsp; &nbsp; &nbsp;--server https://acme-v02.api.letsencrypt.org/directory \</div><div>&nbsp; &nbsp; &nbsp;-d derivationmap.net -d www.derivationmap.net</div><div><br /></div></div><div style="text-align: left;"><span>Your certificate and chain have been saved at:</span></div>&nbsp; &nbsp;/etc/letsencrypt/live/derivationmap.net/fullchain.pem&nbsp; &nbsp;Your key file has been saved at:&nbsp; &nbsp;/etc/letsencrypt/live/derivationmap.net/privkey.pem&nbsp; &nbsp;Your cert will expire on 2021-01-09.<br /><div>https://security.stackexchange.com/questions/94390/whats-the-purpose-of-dh-parameters</div><span style="font-family: courier;">cd&nbsp;/etc/ssl/certs</span><div><span style="font-family: courier;">sudo openssl dhparam -out dhparam.pem 4096</span></div><div><span style="font-family: courier;">cp dhparam.pem ~/proofofconcept/v7_pickle_web_interface/certs/</span></div><div><br /></div><h3 style="text-align: left;">Step 9: restore data from backup</h3><div><span style="font-family: courier;">git clone&nbsp;https://github.com/allofphysicsgraph/proofofconcept.git</span></div><div><span style="font-family: courier;">scp .env user@IP:/home/pdg/proofofconcept/v7_pickle_web_interface/<br /></span></div><div><span style="font-family: courier;">cd&nbsp;proofofconcept/v7_pickle_web_interface/</span><span style="font-family: courier;">flask</span></div><div><span style="font-family: courier;">cp users_sqlite.db_TEMPLATE users_sqlite.db</span></div><div><span style="font-family: courier;">cd ..</span></div><div><span style="font-family: courier;">docker-compose up --build --remove-orphans --detach</span></div><div><span style="font-family: courier;"><br /></span></div>

{% endblock %}