{% extends "_base.html" %}
{% block content %}

<P>modify step

<P>derivation name: <a href="{{ url_for('review_derivation', deriv_id=deriv_id)  }}?referrer=modify_step">{{ dat["derivations"][deriv_id]['name'] }}</a>

<h2>Step graph</h2>
<!-- https://stackoverflow.com/questions/28207761/where-does-flask-look-for-image-files -->
<P><img src="{{ url_for('static', filename=name_of_graphviz_png) }}">

<h2>AST for each expression in step</h2>
<P>From Sympy's parsing of the Latex
{% for ast_png_and_id in list_of_expression_AST_dicts %}
  <P><a href="{{ url_for('list_all_expressions') }}?referrer=modify_step#{{ ast_png_and_id['expr global id'] }}">{{ ast_png_and_id['expr global id'] }}</a>: \({{ dat['expressions'][ast_png_and_id['expr global id']]['latex'] }}\)<BR>
symbols from Sympy: {{ ast_png_and_id['symbols from sympy'] }}<BR>
symbols from PDG AST: {% for symbol_id in ast_png_and_id['symbols from PDG AST'] %}
    (<a href="{{ url_for('list_all_symbols') }}?referrer=modify_step#{{ symbol_id }}">{{ symbol_id }}</a>: {{ dat['symbols'][symbol_id]['latex'] }}), 
    {% endfor %}
<BR>
{% if ast_png_and_id["sympy symbols without PDG AST ID"]|length > 0 %}
    Sympy symbols lacking PDG AST ID: {{ ast_png_and_id["sympy symbols without PDG AST ID"] }}<BR>
{% else %}
    all Sympy symbols have corresponding PDG AST IDs<BR>
{% endif %}
    <img src="{{ url_for('static', filename=ast_png_and_id['ast png filename']) }}">
{% endfor %}

<H2>Symbols in use in this step according to Sympy</h2>
<P>From Sympy's parsing of the Latex
<UL>
  {% for symbol_latex in list_of_symbols_from_sympy %}
  <LI> {{ symbol_latex }} </LI>
  {% endfor %}
</UL>

<h2>Symbols in PDG AST for this step</h2>
<UL>
  {% for symbol_id in list_of_symbols_from_PDG_AST %}
  <LI> <a href="{{ url_for('list_all_symbols') }}?referrer=modify_step#{{ symbol_id }}">{{ symbol_id }}</a>: 
     {{ dat['symbols'][symbol_id]['latex'] }}
  {% endfor %}
</UL>

{% if dict_of_ranked_list.keys()|length > 0 %}
<H2>Symbol matching</H2>
{% for sympy_symbol, list_of_PDG_symbol_IDs in dict_of_ranked_list.items() %}
  {% if list_of_PDG_symbol_IDs|length == 0 %}
    <P>For the symbol {{ sympy_symbol }}, a <a href="{{ url_for('list_all_symbols') }}#add symbol">new symbol entry</a> is probably needed since no match is available.
  {% else %}
    {{ sympy_symbol }} candidates: {{ list_of_PDG_symbol_IDs }}<BR>
  {% endif %}
{% endfor %}
{% else %}
<P>There are no unmatched symbols for this step when comparing Sympy and the PDG ASTs.
{% endif %}
<H2>Options</h2>

<P>
<form method="post" action="">
<!-- https://flask-wtf.readthedocs.io/en/v0.12/csrf.html -->
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
<input type="submit" name="submit_button" value='view step with numeric IDs'>
</form>


<P>
<form method="post" action="">
<!-- https://flask-wtf.readthedocs.io/en/v0.12/csrf.html -->
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
<input type="submit" name="submit_button" value='change inference rule'>
</form>
(Changing the inference rule deletes existing step and prompts for a new step creation.)

<!-- https://jinja.palletsprojects.com/en/2.11.x/templates/#builtin-filters -->
{% if dat["derivations"][deriv_id]['steps'][step_id]['inputs']|length > 0 %}
<a name="change global id">
  <h3>Update the global ID</h3>
</a>
TODO -- not implemented
<form method="post" action="">
 <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

</form>


<a name="edit input expr latex">
  <h3>Edit the latex for an input expression</h3>
</a>
<form method="post" action="">
    <!-- https://flask-wtf.readthedocs.io/en/v0.12/csrf.html -->
    {{ edit_expr_latex_webform.csrf_token }}
<div class="form-group">
    <div class="input-group">
        <span class="input-group-addon">Select from</span>
            <select name="expr_local_id_of_latex_to_modify" class="selectpicker form-control">
              {% for expr_local_id in dat["derivations"][deriv_id]['steps'][step_id]['inputs'] %}
              <option value="{{ expr_local_id }}">{{ dat["expressions"][ dat["expr local to global"][expr_local_id]]['latex'] }}</option>
              {% endfor %}
            </select>
<P>{{ edit_expr_latex_webform.revised_text.label }}: {{ edit_expr_latex_webform.revised_text(size=50, maxlength=300) }} <small>max length = 300 characters</small>
    </div>
<!--    <button type="submit" class="btn btn-default">Update</button> -->
<input type="submit" name="submit_button" value='edit input expr latex'>

  </div>
</form>
{% endif %}

{% if dat["derivations"][deriv_id]['steps'][step_id]['feeds']|length > 0 %}
<a name="edit feed expr latex">
  <h3>Edit the latex for a feed expression</h3>
</a>
<form method="post" action="">
    <!-- https://flask-wtf.readthedocs.io/en/v0.12/csrf.html -->
    {{ edit_expr_latex_webform.csrf_token }}
  <div class="form-group">
    <div class="input-group">
        <span class="input-group-addon">Select from</span>
            <select name="expr_local_id_of_latex_to_modify" class="selectpicker form-control">
              {% for expr_local_id in dat["derivations"][deriv_id]['steps'][step_id]['feeds'] %}
              <option value="{{ expr_local_id }}">{{ dat["expressions"][ dat["expr local to global"][expr_local_id]]['latex'] }}</option>
              {% endfor %}
            </select>
<P>{{ edit_expr_latex_webform.revised_text.label }}: {{ edit_expr_latex_webform.revised_text(size=50, maxlength=300) }} <small>max length = 300 characters</small>
    </div>
    <!--<button type="submit" class="btn btn-default">Update</button> -->
<input type="submit" name="submit_button" value='edit feed expr latex'>

  </div>
</form>
{% endif %}


{% if dat["derivations"][deriv_id]['steps'][step_id]['outputs']|length > 0 %}
<a id="edit output expr latex">
  <h3>Edit the latex for an output expression</h3>
</a>
<form method="post" action="">
    <!-- https://flask-wtf.readthedocs.io/en/v0.12/csrf.html -->
    {{ edit_expr_latex_webform.csrf_token }}
  <div class="form-group">
    <div class="input-group">
        <span class="input-group-addon">Select from</span>
            <select name="expr_local_id_of_latex_to_modify" class="selectpicker form-control">
              {% for expr_local_id in dat["derivations"][deriv_id]['steps'][step_id]['outputs'] %}
              <option value="{{ expr_local_id }}">{{ dat["expressions"][ dat["expr local to global"][expr_local_id]]['latex'] }}</option>
              {% endfor %}
            </select>
<P>{{ edit_expr_latex_webform.revised_text.label }}: {{ edit_expr_latex_webform.revised_text(size=50, maxlength=300) }} <small>max length = 300 characters</small>
    </div>
    <!--<button type="submit" class="btn btn-default">Update</button>-->
<input type="submit" name="submit_button" value='edit output expr latex'>

  </div>
</form>
{% endif %}

<P>
<a name="delete step">
<H3>Delete Step</H3>
</a>
<form method="post" action="">
<!-- https://flask-wtf.readthedocs.io/en/v0.12/csrf.html -->
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
  <div class="form-group">
    <!-- <button type="submit" class="btn btn-default">Delete</button>-->
<input type="submit" name="submit_button" value='delete step'>

  </div>
</form>
</P>

<P>
<a name="change linear index of step">
  <h3>change linear index for step</h3>
 </a>
 Current step index is {{ dat["derivations"][deriv_id]['steps'][step_id]["linear index"] }}.<BR>
 Change step index to
<!-- New linear index must be a rational number greater than zero and must not exist<BR> -->
<form method="post" action="">
<!-- https://flask-wtf.readthedocs.io/en/v0.12/csrf.html -->
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
  <div class="form-group">
    <div class="input-group">
            <select name="linear_index_to_modify" class="selectpicker form-control">
              {% for new_linear_index in list_of_new_linear_indices %}
              <option value="{{ new_linear_index }}">{{ new_linear_index }}</option>
              {% endfor %}
            </select>
    </div>
    <!--<button type="submit" class="btn btn-default">Update</button>-->
<input type="submit" name="submit_button" value='change linear index of step'>

  </div>
</form>
</P>

<P>
  <a name="edit note for step">
    <h3>Edit note for step</H3>
  </a>
  Current note is: {{ dat['derivations'][deriv_id]['steps'][step_id]['notes'] }}
<form method="post" action="">
{{ edit_step_note_webform.csrf_token }}
  <div class="form-group">
    <div class="input-group">
<P>{{ edit_step_note_webform.revised_text.label }}: {{ edit_step_note_webform.revised_text(size=50, maxlength=300) }} <small>max length = 300 characters</small>
    </div>
<!--     <button type="submit" class="btn btn-default">Update</button> -->
<input type="submit" name="submit_button" value='edit note for step'>
  </div>
</form>
</P>


<P>
{% include '_table_of_derivation_steps.html' %}
</P>

{% endblock %}
